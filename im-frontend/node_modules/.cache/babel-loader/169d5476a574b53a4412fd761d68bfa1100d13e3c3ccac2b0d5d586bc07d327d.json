{"ast":null,"code":"import { renderList as _renderList, Fragment as _Fragment, openBlock as _openBlock, createElementBlock as _createElementBlock, createElementVNode as _createElementVNode, toDisplayString as _toDisplayString, createCommentVNode as _createCommentVNode, withModifiers as _withModifiers, resolveComponent as _resolveComponent, withCtx as _withCtx, createBlock as _createBlock, normalizeStyle as _normalizeStyle, pushScopeId as _pushScopeId, popScopeId as _popScopeId } from \"vue\";\nconst _withScopeId = n => (_pushScopeId(\"data-v-9343d6b4\"), n = n(), _popScopeId(), n);\nconst _hoisted_1 = {\n  class: \"conversations\"\n};\nconst _hoisted_2 = {\n  class: \"conversation-list\"\n};\nconst _hoisted_3 = {\n  class: \"conversation-list-container\"\n};\nconst _hoisted_4 = {\n  class: \"conversation-list-content\"\n};\nconst _hoisted_5 = {\n  key: 0\n};\nconst _hoisted_6 = [\"onContextmenu\"];\nconst _hoisted_7 = {\n  class: \"avatar\"\n};\nconst _hoisted_8 = [\"src\"];\nconst _hoisted_9 = {\n  key: 0,\n  class: \"unread-count\"\n};\nconst _hoisted_10 = {\n  class: \"unread\"\n};\nconst _hoisted_11 = {\n  class: \"conversation-message\"\n};\nconst _hoisted_12 = {\n  class: \"conversation-top\"\n};\nconst _hoisted_13 = {\n  class: \"conversation-name\"\n};\nconst _hoisted_14 = {\n  class: \"conversation-time\"\n};\nconst _hoisted_15 = {\n  class: \"conversation-bottom\"\n};\nconst _hoisted_16 = {\n  class: \"conversation-content\"\n};\nconst _hoisted_17 = {\n  key: 0,\n  class: \"unread-text\"\n};\nconst _hoisted_18 = {\n  key: 1\n};\nconst _hoisted_19 = {\n  key: 2\n};\nconst _hoisted_20 = {\n  key: 3,\n  class: \"text\"\n};\nconst _hoisted_21 = {\n  key: 4\n};\nconst _hoisted_22 = {\n  key: 5\n};\nconst _hoisted_23 = {\n  key: 6\n};\nconst _hoisted_24 = {\n  key: 7\n};\nconst _hoisted_25 = {\n  key: 8\n};\nconst _hoisted_26 = {\n  key: 1,\n  class: \"no-conversation\"\n};\nconst _hoisted_27 = {\n  class: \"chat\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  const _component_router_link = _resolveComponent(\"router-link\");\n  const _component_router_view = _resolveComponent(\"router-view\");\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [_createElementVNode(\"div\", _hoisted_2, [_createElementVNode(\"div\", _hoisted_3, [_createElementVNode(\"div\", _hoisted_4, [$setup.conversations.length ? (_openBlock(), _createElementBlock(\"div\", _hoisted_5, [(_openBlock(true), _createElementBlock(_Fragment, null, _renderList($setup.conversations, (conversation, key) => {\n    return _openBlock(), _createBlock(_component_router_link, {\n      key: key\n    }, {\n      default: _withCtx(() => [_createElementVNode(\"div\", {\n        class: \"conversation\",\n        onContextmenu: _withModifiers(e => $setup.showRightClickMenu(e, conversation), [\"prevent\", \"stop\"])\n      }, [_createElementVNode(\"div\", _hoisted_7, [_createElementVNode(\"img\", {\n        src: conversation.data.avatar\n      }, null, 8 /* PROPS */, _hoisted_8), conversation.unread > 0 ? (_openBlock(), _createElementBlock(\"div\", _hoisted_9, [_createElementVNode(\"span\", _hoisted_10, _toDisplayString(conversation.unread), 1 /* TEXT */)])) : _createCommentVNode(\"v-if\", true)]), _createElementVNode(\"div\", _hoisted_11, [_createElementVNode(\"div\", _hoisted_12, [_createElementVNode(\"span\", _hoisted_13, _toDisplayString(conversation.data.name), 1 /* TEXT */), _createElementVNode(\"div\", _hoisted_14, [_createElementVNode(\"div\", null, _toDisplayString(_ctx.formatDate(conversation.lastMessage.timestamp)), 1 /* TEXT */)])]), _createElementVNode(\"div\", _hoisted_15, [_createElementVNode(\"div\", _hoisted_16, [conversation.lastMessage.read === false && conversation.lastMessage.senderId === $setup.currentUser.id ? (_openBlock(), _createElementBlock(\"div\", _hoisted_17, \" [未读] \")) : _createCommentVNode(\"v-if\", true), conversation.type === 'private' ? (_openBlock(), _createElementBlock(\"div\", _hoisted_18, _toDisplayString(conversation.lastMessage.senderId === $setup.currentUser.id ? '我' : conversation.data.name) + \": \", 1 /* TEXT */)) : (_openBlock(), _createElementBlock(\"div\", _hoisted_19, _toDisplayString(conversation.lastMessage.senderId === $setup.currentUser.id ? '我' : conversation.lastMessage.senderData.name) + \": \", 1 /* TEXT */)), conversation.lastMessage.type === 'text' ? (_openBlock(), _createElementBlock(\"span\", _hoisted_20, _toDisplayString(conversation.lastMessage.payload.text), 1 /* TEXT */)) : conversation.lastMessage.type === 'video' ? (_openBlock(), _createElementBlock(\"span\", _hoisted_21, \"[视频消息]\")) : conversation.lastMessage.type === 'audio' ? (_openBlock(), _createElementBlock(\"span\", _hoisted_22, \"[语音消息]\")) : conversation.lastMessage.type === 'image' ? (_openBlock(), _createElementBlock(\"span\", _hoisted_23, \"[图片消息]\")) : conversation.lastMessage.type === 'file' ? (_openBlock(), _createElementBlock(\"span\", _hoisted_24, \"[文件消息]\")) : conversation.lastMessage.type === 'order' ? (_openBlock(), _createElementBlock(\"span\", _hoisted_25, \"[订单消息]\")) : _createCommentVNode(\"v-if\", true)])])])], 40 /* PROPS, HYDRATE_EVENTS */, _hoisted_6)]),\n      _: 2 /* DYNAMIC */\n    }, 1024 /* DYNAMIC_SLOTS */);\n  }), 128 /* KEYED_FRAGMENT */))])) : (_openBlock(), _createElementBlock(\"div\", _hoisted_26, \"- 当前没有会话 -\"))])]), $setup.rightClickMenu.visible ? (_openBlock(), _createElementBlock(\"div\", {\n    key: 0,\n    style: _normalizeStyle({\n      'left': $setup.rightClickMenu.x + 'px',\n      'top': $setup.rightClickMenu.y + 'px'\n    }),\n    class: \"action-box\"\n  }, [_createElementVNode(\"div\", {\n    class: \"action-item\",\n    onClick: _cache[0] || (_cache[0] = (...args) => _ctx.topConversation && _ctx.topConversation(...args))\n  }, _toDisplayString($setup.rightClickMenu.conversation.top ? '取消置顶' : '置顶'), 1 /* TEXT */), _createElementVNode(\"div\", {\n    class: \"action-item\",\n    onClick: _cache[1] || (_cache[1] = (...args) => _ctx.deleteConversation && _ctx.deleteConversation(...args))\n  }, \"删除聊天\")], 4 /* STYLE */)) : _createCommentVNode(\"v-if\", true)]), _createElementVNode(\"div\", _hoisted_27, [(_openBlock(), _createBlock(_component_router_view, {\n    key: _ctx.$route.params.id\n  }))])]);\n}","map":{"version":3,"names":["class","_createElementBlock","_hoisted_1","_createElementVNode","_hoisted_2","_hoisted_3","_hoisted_4","$setup","conversations","length","_hoisted_5","_Fragment","_renderList","conversation","key","_createBlock","_component_router_link","default","_withCtx","onContextmenu","_withModifiers","e","showRightClickMenu","_hoisted_7","src","data","avatar","unread","_hoisted_9","_hoisted_10","_toDisplayString","_hoisted_11","_hoisted_12","_hoisted_13","name","_hoisted_14","_ctx","formatDate","lastMessage","timestamp","_hoisted_15","_hoisted_16","read","senderId","currentUser","id","_hoisted_17","type","_hoisted_18","_hoisted_19","senderData","_hoisted_20","payload","text","_hoisted_21","_hoisted_22","_hoisted_23","_hoisted_24","_hoisted_25","_hoisted_26","rightClickMenu","visible","style","_normalizeStyle","x","y","onClick","_cache","args","topConversation","top","deleteConversation","_hoisted_27","_component_router_view","$route","params"],"sources":["/Users/lynneu/Documents/GitHub/im-frontend/src/views/conversations.vue"],"sourcesContent":["<template>\n    <div class=\"conversations\">\n      <div class=\"conversation-list\">\n        <div class=\"conversation-list-container\">\n          <div class=\"conversation-list-content\">\n            <div v-if=\"conversations.length\">\n              <router-link\n                v-for=\"(conversation, key) in conversations\" :key=\"key\"\n              >\n              <template v-slot:default>\n                <div class=\"conversation\" @contextmenu.prevent.stop=\"e => showRightClickMenu(e,conversation)\">\n                  <div class=\"avatar\">\n                    <img :src=\"conversation.data.avatar\"/>\n                    <div v-if=\"conversation.unread>0\"\n                         class=\"unread-count\">\n                      <span class=\"unread\">{{ conversation.unread }}</span>\n                    </div>\n                  </div>\n                  <div class=\"conversation-message\">\n                    <div class=\"conversation-top\">\n                      <span class=\"conversation-name\">{{ conversation.data.name }}</span>\n                      <div class=\"conversation-time\">\n                        <div>{{ formatDate(conversation.lastMessage.timestamp) }}</div>\n                      </div>\n                    </div>\n                    <div class=\"conversation-bottom\">\n                      <div class=\"conversation-content\">\n                        <div class=\"unread-text\"\n                             v-if=\"conversation.lastMessage.read === false && conversation.lastMessage.senderId === currentUser.id\">\n                          [未读]\n                        </div>\n                        <div v-if=\"conversation.type === 'private'\">\n                          {{ conversation.lastMessage.senderId === currentUser.id ? '我' : conversation.data.name }}:\n                        </div>\n                        <div v-else>\n                          {{ conversation.lastMessage.senderId === currentUser.id ? '我' : conversation.lastMessage.senderData.name }}:\n                        </div>\n                        <span class=\"text\" v-if=\"conversation.lastMessage.type === 'text'\">{{conversation.lastMessage.payload.text}}</span>\n                        <span v-else-if=\"conversation.lastMessage.type === 'video'\">[视频消息]</span>\n                        <span v-else-if=\"conversation.lastMessage.type === 'audio'\">[语音消息]</span>\n                        <span v-else-if=\"conversation.lastMessage.type === 'image'\">[图片消息]</span>\n                        <span v-else-if=\"conversation.lastMessage.type === 'file'\">[文件消息]</span>\n                        <span v-else-if=\"conversation.lastMessage.type === 'order'\">[订单消息]</span>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n            </template>\n              </router-link>\n            </div>\n            <div v-else class=\"no-conversation\">- 当前没有会话 -</div>\n          </div>\n        </div>\n        <div v-if=\"rightClickMenu.visible\" :style=\"{'left': rightClickMenu.x + 'px', 'top': rightClickMenu.y + 'px'}\"\n             class=\"action-box\">\n          <div class=\"action-item\" @click=\"topConversation\">{{ rightClickMenu.conversation.top ? '取消置顶' : '置顶' }}</div>\n          <div class=\"action-item\" @click=\"deleteConversation\">删除聊天</div>\n        </div>\n      </div>\n      <div class=\"chat\">\n        <router-view :key=\"$route.params.id\"/>\n      </div>\n    </div>\n  </template>\n  \n  <script>\n  import { ref, onMounted, onBeforeUnmount, inject } from 'vue'\n  import axios from 'axios'\n  \n  export default {\n    name: 'UserConversations',\n    setup() {\n      const socket = inject('socket')\n      const currentUser = ref({})\n      const conversations = ref([])\n      const rightClickMenu = ref({\n        conversation: null,\n        visible: false,\n        x: null,\n        y: null,\n      })\n  \n      const fetchConversations = async () => {\n        const userId = localStorage.getItem('user').id\n        console.log(userId)\n        console.log(localStorage.getItem('user'))\n        const response = await axios.get(`http://localhost:8000/conversations/${userId}`)\n        conversations.value = response.data\n      }\n  \n      onMounted(async () => {\n        document.addEventListener('click', () => {\n          rightClickMenu.value.visible = false\n        })\n        currentUser.value = localStorage.getItem('user')\n  \n        await fetchConversations()\n  \n        socket.value.onmessage = (event) => {\n          let msg = event.data\n          console.log('Received: ' + msg)\n          // Update the conversations array with the new message\n          // This depends on the structure of your message\n          let data = JSON.parse(msg)\n          conversations.value = data.conversations\n        }\n  \n        socket.value.onclose = (event) => {\n          console.log('WebSocket connection closed: ', event)\n        }\n      })\n  \n      onBeforeUnmount(() => {\n        if (socket.value) {\n          socket.value.close()\n        }\n      })\n  \n      const showRightClickMenu = (e, conversation) => {\n        rightClickMenu.value.conversation = conversation\n        rightClickMenu.value.visible = true\n        rightClickMenu.value.x = e.pageX\n        rightClickMenu.value.y = e.pageY\n      }\n  \n      return {\n        currentUser,\n        conversations,\n        rightClickMenu,\n        showRightClickMenu,\n      }\n    },\n  }\n  </script>\n  \n  <style scoped>\n  .conversations {\n    width: 100%;\n    height: 100%;\n    position: relative;\n    display: flex;\n    color: #333333;\n  }\n\n  .conversation-list {\n    width: 220px;\n  }\n\n  .conversation-list-container {\n    height: 100%;\n    display: flex;\n    flex-direction: column;\n    background-color: white;\n    border-right: #dbd6d6 1px solid;\n  }\n\n  .conversation-list-content {\n    flex: 1;\n    overflow-y: auto;\n    padding: 10px 0;\n    scrollbar-width: none;\n    -ms-overflow-style: none;\n  }\n\n  .conversation-list-content::-webkit-scrollbar {\n    display: none;\n  }\n\n  .no-conversation {\n    text-align: center;\n    color: #666666;\n  }\n\n  .conversation {\n    display: flex;\n    padding: 10px 5px;\n    cursor: pointer;\n  }\n\n  .unread-count {\n    position: absolute;\n    top: -10px;\n    left: 30px;\n    width: 18px;\n    height: 18px;\n    border-radius: 50%;\n    color: white;\n    background: #d02129;\n  }\n\n  .unread-count .unread {\n    display: block;\n    font-size: 12px;\n    text-align: center;\n    line-height: 18px;\n  }\n\n  .conversation-message {\n    flex: 1;\n    padding-left: 5px;\n    display: flex;\n    width: 160px;\n    flex-direction: column;\n    justify-content: space-around;\n  }\n\n  .conversation-top {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    text-align: right;\n  }\n\n  .conversation-name {\n    font-size: 12px;\n    font-weight: 500;\n  }\n\n  .conversation-time {\n    width: 75px;\n    color: #B9B9B9;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .conversation-bottom {\n    display: flex;\n    color: #666666;\n  }\n\n  .conversation-content {\n    display: flex;\n    width: 160px;\n    color: #b3b3b3;\n  }\n\n  .conversation-content .text {\n    overflow: hidden;\n    text-overflow: ellipsis;\n    flex: 1;\n    white-space: nowrap;\n    word-break: break-all;\n  }\n\n  .conversation-bottom .unread-text {\n    color: #d02129;\n    width: 35px !important;\n  }\n\n  .conversation .avatar {\n    width: 40px;\n    height: 40px;\n    position: relative;\n  }\n\n  .conversation .avatar img {\n    width: 100%;\n    border-radius: 10%;\n  }\n\n  .router-link-active {\n    background: #eeeeee;\n  }\n\n  .action-box {\n    width: 100px;\n    height: 60px;\n    background: #ffffff;\n    border: 1px solid #cccccc;\n    position: fixed;\n    z-index: 100;\n    border-radius: 5px;\n  }\n\n  .action-box .action-item {\n    padding-left: 15px;\n    line-height: 30px;\n    font-size: 13px;\n    color: #262628;\n    cursor: pointer;\n  }\n\n  .action-box .action-item:hover {\n    background: #dddddd;\n  }\n\n  .chat {\n    flex: 1;\n    display: flex;\n  }\n\n</style>"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}