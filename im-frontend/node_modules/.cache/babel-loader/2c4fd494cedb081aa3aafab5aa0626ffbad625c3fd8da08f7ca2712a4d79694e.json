{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { ref, reactive, computed, onMounted } from \"vue\";\nimport axios from 'axios';\nimport { useStore } from 'vuex';\nimport { useRouter } from 'vue-router';\nexport default {\n  name: 'HelloWorld',\n  setup() {\n    const router = useRouter();\n    const store = useStore();\n    const user = computed(() => store.state.user); // get user from store\n    const socket = computed(() => store.state.websocket); // get websocket from store\n    const friends = ref([]);\n    const registerUser = reactive({\n      username: '',\n      email: '',\n      password: ''\n    });\n    const friendId = ref(\"\");\n    const message = ref(\"\");\n    const receiveMessage = ref([]);\n    const fetchFriends = async () => {\n      const userId = user.value.id;\n      console.log('yes');\n      console.log(user.value);\n      console.log(userId);\n      const response = await axios.get(`http://localhost:8000/users/${userId}/friends`);\n      friends.value = response.data;\n    };\n    const backtoLogin = () => {\n      console.log('logout');\n      console.log(user.value);\n      socket.value.close();\n      store.commit('clearUserState'); // 调用 mutation 来清除用户状态\n      console.log(user.value);\n      router.push({\n        name: 'UserLogin'\n      });\n    };\n    onMounted(async () => {\n      await fetchFriends();\n      if (socket.value) {\n        socket.value.onmessage = event => {\n          console.log(\"Message from server: \", event.data);\n          const message = JSON.parse(event.data);\n          switch (message.type) {\n            case 'status':\n              {\n                // 更新好友的在线状态\n                const friend = friends.value.find(friend => friend.id === message.content.user_id);\n                if (friend) {\n                  friend.online = message.content.status === 'online';\n                }\n                break;\n              }\n            case 'text':\n              // Handle received messages as before\n              receiveMessage.value.push(event.data);\n              break;\n            default:\n              console.log(\"Unknown message type:\", message.type);\n          }\n        };\n        socket.value.onclose = event => {\n          console.log(\"Socket closed\", event);\n        };\n      }\n    });\n    const register = async () => {\n      try {\n        const response = await axios.post(\"http://localhost:8000/users/\", {\n          username: registerUser.username,\n          email: registerUser.email,\n          password: registerUser.password\n        });\n        console.log(response.data);\n      } catch (error) {\n        console.error(error);\n      }\n    };\n    const addFriend = async () => {\n      try {\n        if (!user.value) {\n          throw new Error('User not logged in');\n        }\n        await axios.put(`http://localhost:8000/users/${user.value.id}/friends/${friendName.value}`);\n        alert('Friend added successfully');\n        await fetchFriends();\n      } catch (error) {\n        console.error(error);\n      }\n    };\n    const sendMessage = () => {\n      if (message.value.trim() !== '' && socket.value && socket.value.readyState === WebSocket.OPEN) {\n        console.log(message.value);\n        socket.value.send(JSON.stringify({\n          receiver_id: friendId.value,\n          content: message.value\n        }));\n        message.value = \"\";\n      }\n    };\n    return {\n      friends,\n      registerUser,\n      friendId,\n      message,\n      receiveMessage,\n      user,\n      // return user\n      socket,\n      // return websocket\n      register,\n      addFriend,\n      sendMessage,\n      backtoLogin\n    };\n  }\n};","map":{"version":3,"names":["ref","reactive","computed","onMounted","axios","useStore","useRouter","name","setup","router","store","user","state","socket","websocket","friends","registerUser","username","email","password","friendId","message","receiveMessage","fetchFriends","userId","value","id","console","log","response","get","data","backtoLogin","close","commit","push","onmessage","event","JSON","parse","type","friend","find","content","user_id","online","status","onclose","register","post","error","addFriend","Error","put","friendName","alert","sendMessage","trim","readyState","WebSocket","OPEN","send","stringify","receiver_id"],"sources":["/Users/lynneu/Documents/GitHub/IM-web/im-frontend/src/views/helloWorld.vue"],"sourcesContent":["<template>\n  <el-container direction=\"vertical\">\n    <el-header style=\"text-align: right; font-size: 20px;\">\n      <el-dropdown>\n        <span v-if=\"user\" class=\"el-dropdown-link\">\n          {{ user.username }}\n          <i class=\"el-icon-arrow-down el-icon--right\"></i>\n        </span>\n        <template v-slot:dropdown>\n          <el-dropdown-menu>\n            <!-- <el-dropdown-item>\n              <router-link :to=\"{ name: 'userProfile' }\">User Profile</router-link>\n            </el-dropdown-item> -->\n            <el-dropdown-item @click=\"backtoLogin\">Logout</el-dropdown-item>\n          </el-dropdown-menu>\n        </template>\n      </el-dropdown>\n    </el-header>\n    <el-main>\n      <el-row :gutter=\"20\">\n        <el-col :span=\"6\">\n          <h2>Test Chat</h2>\n          <el-card class=\"box-card\">\n            <el-form @submit.prevent=\"addFriend\">\n              <el-form-item label=\"Friend's ID\">\n                <el-input v-model=\"friendName\" placeholder=\"friend's ID\"></el-input>\n              </el-form-item>\n              <el-button type=\"primary\" native-type=\"submit\">Add Friend</el-button>\n            </el-form>\n          </el-card>\n        </el-col>\n        <el-col :span=\"18\">\n          <el-card class=\"box-card\">\n            <h2>好友列表</h2>\n            <el-list-item \n              v-for=\"(friend, key) in friends\" \n              :key=\"key\" \n              class=\"friend-item\"\n            >\n              <router-link \n                :to=\"{\n                  name: 'privatechat', \n                  params: { \n                    friendId: friend.id,\n                    friendName: friend.username \n                  }\n                }\"\n              >\n                <div>\n                  <el-tag v-if=\"friend.online\" type=\"success\">在线</el-tag>\n                  <el-tag v-if=\"!friend.online\" type=\"info\">离线</el-tag>\n                  {{ friend.username }}\n                </div>\n              </router-link>\n            </el-list-item>\n          </el-card>\n        </el-col>\n      </el-row>\n    </el-main>\n  </el-container>\n</template>\n\n\n\n\n\n\n  \n<script>\nimport { ref, reactive, computed, onMounted } from \"vue\";\nimport axios from 'axios';\nimport { useStore } from 'vuex'\nimport { useRouter } from 'vue-router'\n\nexport default {\n  name: 'HelloWorld',\n  setup() {\n    const router = useRouter()\n    const store = useStore()\n    const user = computed(() => store.state.user)  // get user from store\n    const socket = computed(() => store.state.websocket) // get websocket from store\n    const friends = ref([]);\n    const registerUser = reactive({\n      username: '',\n      email: '',\n      password: '',\n    });  \n    const friendId = ref(\"\");\n    const message = ref(\"\");\n    const receiveMessage = ref([])\n\n    const fetchFriends = async () => {\n      const userId = user.value.id\n      console.log('yes')\n      console.log(user.value)\n      console.log(userId)\n      const response = await axios.get(`http://localhost:8000/users/${userId}/friends`)\n      friends.value = response.data\n    }\n    \n    const backtoLogin = () => {\n      console.log('logout')\n      console.log(user.value)\n      socket.value.close()\n      store.commit('clearUserState');  // 调用 mutation 来清除用户状态\n      console.log(user.value)\n      \n      router.push({ name: 'UserLogin' });\n    }\n\n    onMounted(async () => {\n      await fetchFriends();\n      if (socket.value) {\n        socket.value.onmessage = (event) => {\n          console.log(\"Message from server: \", event.data);\n          const message = JSON.parse(event.data);\n\n          switch (message.type) {\n            case 'status': {\n              // 更新好友的在线状态\n              const friend = friends.value.find(friend => friend.id === message.content.user_id);\n              if (friend) {\n                friend.online = message.content.status === 'online';\n              }\n              break;\n            }\n            case 'text':\n              // Handle received messages as before\n              receiveMessage.value.push(event.data)\n              break;\n            default:\n              console.log(\"Unknown message type:\", message.type);\n          }\n        };\n  \n        socket.value.onclose = (event) => {\n          console.log(\"Socket closed\", event);\n        };\n      }\n    });\n\n    const register = async () => {\n      try {\n        const response = await axios.post(\"http://localhost:8000/users/\", {\n          username: registerUser.username,\n          email: registerUser.email,\n          password: registerUser.password,\n        });\n        console.log(response.data);\n      } catch (error) {\n        console.error(error);\n      }\n    };\n\n    const addFriend = async () => {\n      try {\n        if (!user.value) {\n          throw new Error('User not logged in');\n        }\n        await axios.put(`http://localhost:8000/users/${user.value.id}/friends/${friendName.value}`);\n        alert('Friend added successfully');\n        await fetchFriends(); \n      } catch (error) {\n        console.error(error);\n      }\n    };\n\n    const sendMessage = () => {\n      if (message.value.trim() !== '' && socket.value && socket.value.readyState === WebSocket.OPEN) {\n        console.log(message.value);\n        socket.value.send(JSON.stringify({\n          receiver_id: friendId.value,\n          content: message.value\n        }));\n        message.value = \"\";\n      }\n    };\n\n    return {\n      friends,\n      registerUser,\n      friendId,\n      message,\n      receiveMessage,\n      user,  // return user\n      socket, // return websocket\n      register,\n      addFriend,\n      sendMessage,\n      backtoLogin\n    };\n  },\n};\n</script>\n\n  \n  <style scoped>\n/* .section {\n  margin-bottom: 2rem;\n}\n\n.friend-item, .message-item {\n  border: 1px solid #ccc;\n  padding: 1rem;\n  margin-bottom: 1rem;\n}\n\n.status-online {\n  color: green;\n}\n\n.status-offline {\n  color: red;\n} */\n\n.el-header {\n  background-color: #B3C0D1;\n  color: #333;\n  line-height: 60px;\n}\n\n.friend-item {\n  margin-bottom: 15px;\n}\n\n</style>"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}